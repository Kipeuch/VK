## Задание 1
### Структуры данных и ключевые компоненты:

1. **`SubPubBus`**:
   Управляет подписками и публикациями сообщений.

2. **`Subscriber`**:
   Структура вида:
    * `handler`: callback-функция для обработки полученных сообщений.
    * `queue`: очередь сообщений
    * `msgCh` и `closeCh`: каналы для управления обработкой сообщений и завершением работы подписчика. 
---

### Основные операции:

1. **`Subscribe`**: добавляет нового подписчика на топик (`subject`).
    * Для этого создается новый объект `Subscriber` для того чтобы в фоновом режиме обрабатывать сообщения, чтобы один подписчик не тормозил других подписчиков.
    * `Subscriber` добавляется в шину данных слоя subpub.
    * Если шина сообщений уже закрыта (флаг `sp.closed`), возвращается ошибка.

2. **`Publish`**: публикует сообщение для выбранной темы.
    * Сообщение передается всем подписчикам, подписанным на данную тему.
    * Каждому подписчику добавляется сообщение в его локальную очередь, и запускает горутину на обработку сообщений, если она еще не запущена.
    * Если нет подписчиков на эту тему или шина закрыта, метод возвращает ошибку.
    * Генерирует ключ идемпотентности на публикацию для отправки в задании 2

3. **`Close`**: закрывает шину сообщений.
    * Он блокирует дальнейшие публикации и подписки.
    * После этого для каждого подписчика вызывается метод `Unsubscribe`, который отменяет его подписку.
    * Используется контекст для проверки отмены операции. Если контекст отменен, выполнение прерывается, и подписчики продолжают работать до завершения обработки сообщений.

4. **`Unsubscribe` (для подписчика)**:
    * Подписчик может отписаться от получения сообщений. Этот метод закрывает каналы подписчика и удаляет его из списка подписчиков в шине сообщений.

5. **Обработка сообщений**:
    * Каждый подписчик работает в своей горутине. Он прослушивает очередь сообщений и обрабатывает их в порядке добавления (FIFO).
    * Если очередь пустая, горутина завершается; флаг processing меняется на False.
    * Горутина запускается заново при получении нового сообщения.
---


## Задание 2

### Запуск сервиса:

```bash
go mod tidy
go run ./cmd/service/main.go
```

Сервис поддерживает **graceful shutdown**:(см. [main.go](cmd/service/main.go));

Шина и основной **UseCase** покрыты unit тестами.

Сделан нагрузочный тест для проверки работы сервиса

### Логика работы сервиса:
* [`cmd/load_test/`](cmd/load_test/)
  Нагрузочный тест для сервиса.

* [`internal/generated/service/`](internal/generated/service/)
  Сгенерированные gRPC-файлы.

* [`internal/rpc/`](internal/rpc/)
  Реализация gRPC-хендлеров и логики подписки/публикации.

* [`internal/eventbus/consume/handle_message/`](internal/eventbus/consume/handle_message/)
  Обработка входящих событий из EventBus. Здесь хранятся функции, применяемые к каждому сообщению(в данном случае просто отправка подписчику).

* [`internal/service/stream_manager/`](internal/service/stream_manager/)
  Управление активными соединениями со стороны клиентов (добавление, удаление, рассылка публикаций). Отправляет публикацию всем соединениям, подписанным на топик и добавляет ключ идемпотентности в мапку, чтобы не присылать сообщения повторно. 
  Раз в 24 часа горутина отчищает использованные ключи.

* [`internal/service/subpub/`](internal/service/subpub/)
  Реализация шины событий

* [`internal/config/`](internal/config/)
  Конфигурация сервиса.

* [`internal/utils/`](internal/utils/)
  Вспомогательные утилиты:
  * очередь сообщений
  * функция WithLock, реализующая мьютекс с обработкой паники
---
